fiber = require('fiber')
---
...
space = box.schema.create_space('tweedledum')
---
...
space:create_index('primary', { type = 'hash' })
---
...
-- A test case for a race condition between ev_schedule
-- and wal_schedule fiber schedulers.
-- The same fiber should not be scheduled by ev_schedule (e.g.
-- due to cancellation) if it is within th wal_schedule queue.
-- The test case is dependent on rows_per_wal, since this is when
-- we reopen the .xlog file and thus wal_scheduler takes a long
-- pause
box.cfg.rows_per_wal
---
- 50
...
space:insert{1, 'testing', 'lua rocks'}
---
- [1, 'testing', 'lua rocks']
...
space:delete{1}
---
- [1, 'testing', 'lua rocks']
...
space:insert{1, 'testing', 'lua rocks'}
---
- [1, 'testing', 'lua rocks']
...
space:delete{1}
---
- [1, 'testing', 'lua rocks']
...
space:insert{1, 'test box delete'}
---
- [1, 'test box delete']
...
space:delete{1}
---
- [1, 'test box delete']
...
space:insert{1, 'test box delete'}
---
- [1, 'test box delete']
...
space:delete{1}
---
- [1, 'test box delete']
...
space:insert{1684234849, 'test box delete'}
---
- [1684234849, 'test box delete']
...
space:delete{1684234849}
---
- [1684234849, 'test box delete']
...
space:insert{1684234849, 'test box delete'}
---
- [1684234849, 'test box delete']
...
space:delete{1684234849}
---
- [1684234849, 'test box delete']
...
space:insert{1684234849, 'test box.select()'}
---
- [1684234849, 'test box.select()']
...
space:replace{1684234849, 'hello', 'world'}
---
- [1684234849, 'hello', 'world']
...
space:replace{1667655012, 'goodbye', 'universe'}
---
- [1667655012, 'goodbye', 'universe']
...
space:replace{1667655012, 'goodbye', 'universe'}
---
- [1667655012, 'goodbye', 'universe']
...
space:replace{1667655012, 'goodbye', 'universe'}
---
- [1667655012, 'goodbye', 'universe']
...
space:replace{1667655012, 'goodbye', 'universe'}
---
- [1667655012, 'goodbye', 'universe']
...
space:replace{1667655012, 'goodbye', 'universe'}
---
- [1667655012, 'goodbye', 'universe']
...
space:replace{1667655012, 'goodbye', 'universe'}
---
- [1667655012, 'goodbye', 'universe']
...
space:replace{1667655012, 'goodbye', 'universe'}
---
- [1667655012, 'goodbye', 'universe']
...
space:replace{1667655012, 'goodbye', 'universe'}
---
- [1667655012, 'goodbye', 'universe']
...
space:replace{1667655012, 'goodbye', 'universe'}
---
- [1667655012, 'goodbye', 'universe']
...
space:replace{1667655012, 'goodbye', 'universe'}
---
- [1667655012, 'goodbye', 'universe']
...
space:replace{1667655012, 'goodbye', 'universe'}
---
- [1667655012, 'goodbye', 'universe']
...
space:replace{1667655012, 'goodbye', 'universe'}
---
- [1667655012, 'goodbye', 'universe']
...
space:replace{1684234849}
---
- [1684234849]
...
space:delete{1684234849}
---
- [1684234849]
...
space:delete{1667655012}
---
- [1667655012, 'goodbye', 'universe']
...
space:insert{1953719668, 'old', 1684234849}
---
- [1953719668, 'old', 1684234849]
...
-- test that insert produces a duplicate key error
space:insert{1953719668, 'old', 1684234849}
---
- error: Duplicate key exists in unique index 0
...
space:update(1953719668, {{'=', 0, 1936941424}, {'=', 1, 'new'}})
---
- [1936941424, 'new', 1684234849]
...
space:update(1234567890, {{'+', 2, 1}})
---
...
space:update(1936941424, {{'+', 2, 1}})
---
- [1936941424, 'new', 1684234850]
...
space:update(1936941424, {{'-', 2, 1}})
---
- [1936941424, 'new', 1684234849]
...
space:update(1936941424, {{'-', 2, 1}})
---
- [1936941424, 'new', 1684234848]
...
space:update(1936941424, {{'+', 2, 1}})
---
- [1936941424, 'new', 1684234849]
...
space:delete{1936941424}
---
- [1936941424, 'new', 1684234849]
...
-- must be read-only
space:insert{1953719668}
---
- [1953719668]
...
space:insert{1684234849}
---
- [1684234849]
...
space:delete{1953719668}
---
- [1953719668]
...
space:delete{1684234849}
---
- [1684234849]
...
space:insert{1953719668, 'hello world'}
---
- [1953719668, 'hello world']
...
space:update(1953719668, {{'=', 1, 'bye, world'}})
---
- [1953719668, 'bye, world']
...
space:delete{1953719668}
---
- [1953719668, 'bye, world']
...
-- test tuple iterators
t = space:insert{1953719668}
---
...
t = space:replace{1953719668, 'another field'}
---
...
t = space:replace{1953719668, 'another field', 'one more'}
---
...
space:truncate()
---
...
-- test passing arguments in and out created fiber
--# setopt delimiter ';'
function y()
    fiber.detach('started')
    space = box.space['tweedledum']
    while true do
        space:replace{1953719668, os.time()}
        fiber.sleep(0.001)
    end
end;
---
...
f = fiber.create(y);
---
...
fiber.resume(f);
---
- started
...
fiber.sleep(0.002);
---
...
fiber.cancel(f);
---
...
fiber.resume(f);
---
- error: 'fiber.resume(): the fiber is dead'
...
for k = 1, 1000, 1 do
    fiber.create(
        function()
            fiber.detach()
        end
    )
end;
---
...
--# setopt delimiter ''
collectgarbage('collect')
---
- 0
...
-- check that these newly created fibers are garbage collected
fiber.find(900)
---
- null
...
fiber.find(910)
---
- null
...
fiber.find(920)
---
- null
...
fiber.find()
---
- error: 'fiber.find(id): bad arguments'
...
fiber.find('test')
---
- null
...
--  https://github.com/tarantool/tarantool/issues/131
--  fiber.resume(fiber.cancel()) -- hang
f = fiber.create(function() fiber.cancel(fiber.self()) end)
---
...
fiber.resume(f)
---
- error: 'fiber.resume(): the child fiber got cancelled'
...
f = nil
---
...
-- https://github.com/tarantool/tarantool/issues/119
ftest = function() fiber.sleep(0.01 * math.random() ) return true end
---
...
--# setopt delimiter ';'
for i = 1, 10 do
    result = {}
    for j = 1, 300 do
        fiber.resume(fiber.create(function()
            fiber.detach()
            table.insert(result, ftest())
        end))
    end
    while #result < 300 do fiber.sleep(0.01) end
end;
---
...
--# setopt delimiter ''
#result
---
- 300
...
--# setopt delimiter ''
--
-- 
--  Test fiber.wrap()
-- 
--  This should try to infinitely create fibers,
--  but hit the fiber stack size limit and fail
--  with an error.
f = function() fiber.wrap(f) end
---
...
f()
---
...
-- 
-- Test argument passing
-- 
f = function(a, b) fiber.wrap(function(arg) result = arg end, a..b) end
---
...
f('hello ', 'world')
---
...
result
---
- hello world
...
f('bye ', 'world')
---
...
result
---
- bye world
...
-- 
-- Test that the created fiber is detached
-- 
fiber.wrap(function() result = fiber.status() end)
---
- null
...
result
---
- running
...
-- A test case for Bug#933487
-- tarantool crashed during shutdown if non running LUA fiber
-- was created
f = fiber.create(function () return true end)
---
...
box.snapshot()
---
- ok
...
box.snapshot()
---
- error: can't save snapshot, errno 17 (File exists)
...
box.snapshot()
---
- error: can't save snapshot, errno 17 (File exists)
...
fiber.resume(f)
---
- true
- true
...
f = fiber.create(function () return true end)
---
...
fiber.sleep(0)
---
...
fiber.sleep(0.01)
---
...
fiber.sleep(0.0001)
---
...
fiber.sleep('hello')
---
- error: 'fiber.sleep(delay): bad arguments'
...
fiber.sleep(box, 0.001)
---
- error: 'fiber.sleep(delay): bad arguments'
...
fiber.cancel(fiber.self())
---
- error: 'fiber.cancel(): subject fiber does not permit cancel'
...
f = fiber.self()
---
...
old_id = f:id()
---
...
fiber.cancel(f)
---
- error: 'fiber.cancel(): subject fiber does not permit cancel'
...
fiber.self():id() - old_id < 3
---
- true
...
fiber.cancel(fiber.self())
---
- error: 'fiber.cancel(): subject fiber does not permit cancel'
...
fiber.self():id() - old_id < 5
---
- true
...
g = fiber.self()
---
...
f==g
---
- true
...
function r() f = fiber.create(r) return (fiber.resume(f)) end
---
...
r()
---
- true
...
f = fiber.create(print('hello'))
---
- error: '[string "f = fiber.create(print(''hello'')) "]:1: fiber.create(function):
    bad arguments'
...
fiber.resume(f)
---
- error: 'fiber.resume(): the fiber is dead'
...
-- test passing arguments in and out created fiber
function r(a, b) return a, b end
---
...
f=fiber.create(r)
---
...
fiber.resume(f)
---
- true
- null
- null
...
f=fiber.create(r)
---
...
fiber.resume(f, 'hello')
---
- true
- hello
- null
...
f=fiber.create(r)
---
...
fiber.resume(f, 'hello', 'world')
---
- true
- hello
- world
...
f=fiber.create(r)
---
...
fiber.resume(f, 'hello', 'world', 'wide')
---
- true
- hello
- world
...
function y(a, b) c=fiber.yield(a) return fiber.yield(b, c) end
---
...
f=fiber.create(y)
---
...
fiber.resume(f, 'hello', 'world')
---
- hello
...
fiber.resume(f, 'wide')
---
- world
- wide
...
fiber.resume(f)
---
- true
...
function y() fiber.detach() while true do box.replace(0, 1953719668, os.time()) fiber.sleep(0.001) end end
---
...
f = fiber.create(y)
---
...
fiber.resume(f)
---
...
fiber.sleep(0.002)
---
...
fiber.cancel(f)
---
- error: 'fiber.resume(): the fiber is dead'
...
fiber.resume(f)
---
- error: 'fiber.resume(): the fiber is dead'
...
f=nil
---
...
for k=1, 10000, 1 do fiber.create(function() fiber.detach() end) end
---
...
collectgarbage('collect')
---
- 0
...
-- check that these newly created fibers are garbage collected
fiber.find(9000)
---
- null
...
fiber.find(9010)
---
- null
...
fiber.find(9020)
---
- null
...
--  test fiber.status functions: invalid arguments
fiber.status(1)
---
- error: 'bad argument #1 to ''?'' (fiber expected, got number)'
...
fiber.status('fafa-gaga')
---
- error: 'bad argument #1 to ''?'' (fiber expected, got string)'
...
fiber.status(nil)
---
- error: 'bad argument #1 to ''?'' (fiber expected, got nil)'
...
--  A test case for Bug#911641 fiber.sleep() works incorrectly if
--  a fiber is attached.
function r() return fiber.sleep(0.01) end
---
...
f = fiber.create(r)
---
...
fiber.resume(f)
---
- true
...
fiber.resume(f)
---
- error: 'fiber.resume(): the fiber is dead'
...
--# setopt delimiter ';'
function r()
    fiber.yield(box.space.tweedledum:insert{0, 0, 1})
    fiber.yield(box.space.tweedledum:get{0})
    fiber.yield(box.space.tweedledum:truncate())
end;
---
...
--# setopt delimiter ''
f = fiber.create(r)
---
...
fiber.resume(f)
---
- [0, 0, 1]
...
fiber.resume(f)
---
- [0, 0, 1]
...
fiber.resume(f)
---
...
fiber.resume(f)
---
- true
...
function r() return fiber.yield(fiber.create(r)) end
---
...
f = r()
---
...
f1 = fiber.resume(f)
---
...
f2 = fiber.resume(f1)
---
...
f3 = fiber.resume(f2)
---
...
f4 = fiber.resume(f3)
---
...
f5 = fiber.resume(f4)
---
...
f6 = fiber.resume(f5)
---
...
f7 = fiber.resume(f6)
---
...
f8 = fiber.resume(f7)
---
...
f9 = fiber.resume(f8)
---
...
f10 = fiber.resume(f9)
---
...
f11 = fiber.resume(f10)
---
...
f12 = fiber.resume(f11)
---
...
f13 = fiber.resume(f12)
---
...
f14 = fiber.resume(f13)
---
...
f15 = fiber.resume(f14)
---
...
f16 = fiber.resume(f15)
---
...
f17 = fiber.resume(f16)
---
...
fiber.resume(f)
---
- true
...
fiber.resume(f1)
---
- true
...
fiber.resume(f2)
---
- true
...
fiber.resume(f3)
---
- true
...
fiber.resume(f4)
---
- true
...
fiber.resume(f5)
---
- true
...
fiber.resume(f6)
---
- true
...
fiber.resume(f7)
---
- true
...
fiber.resume(f8)
---
- true
...
fiber.resume(f9)
---
- true
...
fiber.resume(f10)
---
- true
...
fiber.resume(f11)
---
- true
...
fiber.resume(f12)
---
- true
...
fiber.resume(f13)
---
- true
...
fiber.resume(f14)
---
- true
...
fiber.resume(f15)
---
- true
...
fiber.resume(f16)
---
- true
...
f17 = nil
---
...
function r() fiber.detach() fiber.sleep(1000) end
---
...
f = fiber.create(r)
---
...
fiber.resume(f)
---
...
fiber.resume(f)
---
- error: 'fiber.resume(): can''t resume a detached fiber'
...
fiber.cancel(f)
---
...
fiber.resume(f)
---
- error: 'fiber.resume(): the fiber is dead'
...
--  Test fiber.name()
old_name = fiber.name()
---
...
fiber.name() == old_name
---
- true
...
fiber.self():name() == old_name
---
- true
...
fiber.name('hello fiber')
---
...
fiber.name()
---
- hello fiber
...
fiber.self():name('bye fiber')
---
...
fiber.self():name()
---
- bye fiber
...
fiber.self():name(old_name)
---
...
space:drop()
---
...
-- box.fiber test (create, resume, yield, status)
dofile("fiber.lua")
---
...
-- print run fiber's test
box_fiber_run_test()
---
- - 'tester: status(tester) = running'
  - 'tester: status(printer) = suspended'
  - 'count: 1'
  - 'printer: tester status = normal'
  - 'printer: printer status = running'
  - 'A: odd  1'
  - 'status: suspended'
  - 'count: 2'
  - 'B: odd  1'
  - 'C: event  2'
  - 'status: suspended'
  - 'count: 3'
  - 'A: odd  3'
  - 'status: suspended'
  - 'count: 4'
  - 'B: odd  3'
  - 'C: event  4'
  - 'D: event  4'
  - 'A: odd  5'
  - 'status: suspended'
  - 'count: 5'
  - 'B: odd  5'
  - 'status: dead'
...
function testfun() while true do fiber.sleep(10) end end
---
...
f = fiber.wrap(testfun)
---
...
f:cancel()
---
...
f:resume()
---
- error: 'fiber.resume(): the fiber is dead'
...
fib_id = fiber.wrap(testfun):id()
---
...
fiber.find(fib_id):cancel()
---
...
fiber.find(fib_id)
---
- null
...
box.fiber = nil
---
...
